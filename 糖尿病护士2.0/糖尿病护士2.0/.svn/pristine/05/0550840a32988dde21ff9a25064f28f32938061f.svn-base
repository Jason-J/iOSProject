//
//  addContactsController.m
//  TangNiaoBingHuShi
//
//  Created by qimingfang-dwk on 14/12/9.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "addContactsController.h"

@interface addContactsController ()<UITextFieldDelegate>
@property (weak, nonatomic) IBOutlet UITextField *realnameTF;
@property (weak, nonatomic) IBOutlet UITextField *contactTF;
@property (weak, nonatomic) IBOutlet UITextField *phoneTF;
@property (weak, nonatomic) IBOutlet UITextField *codeTF;

@property (nonatomic,strong) NSString * code;
@end

@implementation addContactsController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.code = [[NSString alloc] init];
    
    self.realnameTF.delegate = self;
    self.contactTF.delegate = self;
    self.phoneTF.delegate = self;
    self.codeTF.delegate = self;
}
- (IBAction)getcodeAction:(id)sender {
    JSNetWorking * js = [[JSNetWorking alloc] init];
    NSString * url = [NSString stringWithFormat:@"http://test.tanghushi.com/api/mobile/?version=2&module=verify&op=getverify&mobiles=%@&yy=0",_phoneTF.text];
    [js getRequestWithURLStr:url success:^(id ResultData) {
        id value = [[ResultData objectForKey:@"Variables"] objectForKey:@"value"];
        NSLog(@"%@",value);
        if ([value intValue]==0) {
            DXAlertView * alertView = [[DXAlertView alloc] initWithTitle:@"提示" contentText:@"该手机号已经添加过了哦~" leftButtonTitle:nil rightButtonTitle:@"确定"];
            [alertView show];
        } else{
            NSLog(@"验证码=%@",value);
            NSNumberFormatter* numberFormatter = [[NSNumberFormatter alloc] init];
            NSString * str = [numberFormatter stringFromNumber:value];
            self.code = str;
        }
    } failure:^(NSError *error, AFHTTPRequestOperation *operation) {
        NSLog(@"请求错误%@",error);
    }];
}
- (IBAction)saveAction:(id)sender {
     if ([_realnameTF.text isEqualToString:@""] || [_phoneTF.text isEqualToString:@""]||[_codeTF.text isEqualToString:@""]) {
         DXAlertView * alertView = [[DXAlertView alloc] initWithTitle:@"提示" contentText:@"真实姓名和手机不能为空" leftButtonTitle:nil rightButtonTitle:@"确定"];
         [alertView show];
     } else if([self.code isEqualToString:_codeTF.text]==NO){
         DXAlertView * alert = [[DXAlertView alloc] initWithTitle:@"提示" contentText:@"验证码不正确" leftButtonTitle:nil rightButtonTitle:@"确定"];
         [alert show];
     }else{
         [self addContactRequest];
     }
  }

#pragma mark - request
- (void)addContactRequest{
    JSNetWorking * js = [[JSNetWorking alloc] init];
    NSString * url = [NSString stringWithFormat:@"http://test.tanghushi.com/api/mobile/?version=2&module=clock&op=addmember&fname=%@&relationship=%@&mobiles=%@",_realnameTF.text,_contactTF.text,_phoneTF.text];
    [js getRequestWithURLStr:url success:^(id ResultData) {
        id value = [[ResultData objectForKey:@"Variables"] objectForKey:@"value"];
        NSLog(@"%@",value);
        if ([value intValue]==1) {
            [FVCustomAlertView showDefaultDoneAlertOnView:self.view withTitle:@"添加成功"];
            if (self.block!=nil) {
                
                self.block(YES);
            }
        } else{
            [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"添加失败"];
        }
    } failure:^(NSError *error, AFHTTPRequestOperation *operation) {
        NSLog(@"error = %@",error);
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"添加错误"];
    }];

}
#pragma mark - blockReturn
-(void)addSuccess:(RETURNBLOCK)block{
    
        self.block=block;
  
}
-(BOOL)textFieldShouldReturn:(UITextField *)textField{
    [textField resignFirstResponder];
    return YES;
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
