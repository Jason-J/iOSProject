//
//  AddMedicineViewController.m
//  TangNiaoBingHuShi
//
//  Created by Jason on 14-12-3.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "AddMedicineViewController.h"
#import "MyAddMedicineView.h"

@interface AddMedicineViewController ()<UITableViewDataSource, UITableViewDelegate,UISearchBarDelegate, UIAlertViewDelegate>
@property (nonatomic, strong) UITableView *tableView;
@property (nonatomic, strong) NSMutableArray *array;
@property (nonatomic, strong) Medicine *medicine;
@end

@implementation AddMedicineViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    // Do any additional setup after loading the view.
    _array = [[NSMutableArray alloc] init];
    self.title = @"搜索药物";
    _medicine =[[Medicine alloc] init];

    NSLog(@"%@", _useMedicineTime);
    _tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT) style:UITableViewStylePlain];
    _tableView.delegate = self;
    _tableView.dataSource = self;
    [_tableView registerClass:[UITableViewCell class] forCellReuseIdentifier:@"reuse"];
    [self.view addSubview:_tableView];
    
    MyAddMedicineView *myAddMedicineView = [[[NSBundle mainBundle] loadNibNamed:@"MyAddMedicineView" owner:self options:nil]lastObject];

    _tableView.tableHeaderView = myAddMedicineView;
    [myAddMedicineView valueOfSearchBar:^(UISearchBar *searchBar) {
        [self getDataFromServerWithSearchBar:searchBar];
    }];
//    UISearchBar *searchBar = [[UISearchBar alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 44)];
//    _tableView.tableHeaderView = searchBar;
//    searchBar.delegate = self;
}
-(void)searchBarSearchButtonClicked:(UISearchBar *)searchBar
{
    [self getDataFromServerWithSearchBar:searchBar];
}
-(void)getDataFromServerWithSearchBar:(UISearchBar*)searchBar
{
    [FVCustomAlertView showDefaultLoadingAlertOnView:self.view withTitle:@"努力加载中。。。"];
    NSString *str = [[NSString  stringWithFormat:@"http://www.tanghushi.com/api/mobile/?version=2&module=medicine_project&op=search&q=%@", searchBar.text]stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
    NSURL *url = [NSURL URLWithString:str];
    NSURLRequest *request = [NSURLRequest requestWithURL:url cachePolicy:NSURLRequestReloadIgnoringLocalCacheData timeoutInterval:20];
    AFHTTPRequestOperation *operation = [[AFHTTPRequestOperation alloc] initWithRequest:request];
    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
        id object = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableLeaves error:nil];
        NSLog(@"%@", object);
        NSArray *array = [[NSArray alloc] initWithArray:[[object objectForKey:@"Variables"] objectForKey:@"value"]];
        NSLog(@"%@", array);
        [_array removeAllObjects];
        for (int i = 0; i < array.count; i++) {
            Medicine *medicine = [[Medicine alloc] init];
            [medicine setValuesForKeysWithDictionary:array[i]];
            [_array addObject:medicine];
            
        }
        NSLog(@"%@", _array);
        [_tableView reloadData];
        MyAddMedicineView *myAddMedicineView = [[[NSBundle mainBundle] loadNibNamed:@"MyAddMedicineView" owner:self options:nil]lastObject];
            [myAddMedicineView valueOfSearchBar:^(UISearchBar *searchBar) {
                [self getDataFromServerWithSearchBar:searchBar
                 ];
            }];
        _tableView.tableHeaderView = myAddMedicineView;
        [FVCustomAlertView hideAlertFromView:self.view fading:YES];
        

    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        [FVCustomAlertView hideAlertFromView:self.view fading:YES];
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"加载失败"];
        
    }];
    [operation start];
}
#pragma  mark- UIAlertView Delegate
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (buttonIndex ==1) {
        if ([self isPureInt:[[alertView textFieldAtIndex:0] text]] ) {
            
            _medicine.dose = [[alertView textFieldAtIndex:0] text];
            _medicine.useMedicineTime = _useMedicineTime;
            if (_medicineBlock) {
                
                self.medicineBlock(_medicine);
            }
            [FVCustomAlertView showDefaultDoneAlertOnView:self.view withTitle:@"添加成功"];
            [self.navigationController popViewControllerAnimated:YES];
        }
    }
    
}
-(void)valueOfMedicine:(RETURNMEDICINE)medicineBlock
{
    self.medicineBlock = medicineBlock;
}
#pragma  mark- 判断输入是否为纯数字
-(BOOL)isPureInt:(NSString *)str
{
    NSScanner *scan = [NSScanner scannerWithString:str];
    int val ;
    return [scan scanInt:&val] && [scan isAtEnd];
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    _medicine = [_array objectAtIndex:indexPath.row];
    if (_isAddDose) {
        UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:@"糖尿病护士提醒" message:@"请输入用药剂量(单位:片)" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确认", nil];
        alertView.alertViewStyle = UIAlertViewStylePlainTextInput;
        [alertView show];
        
    } else {
        if (_medicineBlock) {
            JSNetWorking *network = [[JSNetWorking alloc] init];
            NSString *urlstr = [NSString stringWithFormat:@"http://www.tanghushi.com/api/mobile/?version=2&module=medicine_project&op=addrecord&id=%@&tag=1", _medicine.auto_id];
            [network getRequestWithURLStr:urlstr success:^(id ResultData) {
                NSLog(@"%@", ResultData);
                self.medicineBlock(_medicine);
                [self.navigationController popViewControllerAnimated:YES];
            } failure:^(NSError *error, AFHTTPRequestOperation *operation) {
                
            }];
      
        }
        
        
    }
    
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    NSString *str = @"reuse";
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:str];
    Medicine *medicine = [_array objectAtIndex:indexPath.row];
    cell.textLabel.text = medicine.medicine_name;
    return cell;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return _array.count;
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
