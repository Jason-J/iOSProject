//
//  MyQuestionViewController.m
//  TangNiaoBingHuShi
//
//  Created by Jason on 14-11-22.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "MyQuestionViewController.h"
#import "HZAreaPickerView.h"
#import "QRadioButton.h"
#import "ELCImagePickerController.h"
#import "User.h"
#import "LoginViewController.h"
#import "MyQuestionDetailViewController.h"
#import "LoginState.h"
@interface MyQuestionViewController ()<HZAreaPickerDelegate, UIActionSheetDelegate, UITextViewDelegate, UITextFieldDelegate,ELCImagePickerControllerDelegate,UIImagePickerControllerDelegate>

@property (weak, nonatomic) IBOutlet UILabel *placeholderLabel;
@property (weak, nonatomic) IBOutlet UILabel *locationLabel;

@property (weak, nonatomic) IBOutlet UIButton *selectLocationBtn;
@property (nonatomic, strong) HZAreaPickerView *locatePicker;

@property (weak, nonatomic) IBOutlet UIButton *leftSelectBtn;
@property (weak, nonatomic) IBOutlet UIButton *centerSelectBtn;
@property (weak, nonatomic) IBOutlet UIButton *rightSelectBtn;
@property (weak, nonatomic) IBOutlet UILabel *ageLabel;

@property (weak, nonatomic) IBOutlet UITextView *textView;
@property (weak, nonatomic) IBOutlet UITextField *textField;
@property (weak, nonatomic) IBOutlet UIView *sexView;
@property (nonatomic, assign) NSInteger buttonNum;
@property (nonatomic, strong) QRadioButton *maleRadioBtn;
@property (nonatomic, strong) QRadioButton *femaleRadioBtn;
@property (nonatomic, copy) NSString *sex;
@end                                                                                                                

@implementation MyQuestionViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.view.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"backgroundImage.png"]];
    _textView.delegate = self;
    _textField.delegate = self;
    
    _maleRadioBtn = [[QRadioButton alloc] initWithDelegate:self groupId:@"sex"];
    _femaleRadioBtn = [[QRadioButton alloc] initWithDelegate:self groupId:@"sex"];
    [_maleRadioBtn setTitle:@"男" forState:UIControlStateNormal];
    [_maleRadioBtn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
     [_femaleRadioBtn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    _maleRadioBtn.checked = YES;
    [_femaleRadioBtn setTitle:@"女" forState:UIControlStateNormal];
    _femaleRadioBtn.frame = CGRectMake(SCREEN_WIDTH - 60, 5, 60, 30);
    _maleRadioBtn.frame = CGRectMake(_femaleRadioBtn.frame.origin.x - 60, 5, 60, 30);
    [_sexView addSubview:_maleRadioBtn];
    [_sexView addSubview:_femaleRadioBtn];
    _leftSelectBtn.tag = 10000;
    _centerSelectBtn.tag = 20000;
    _rightSelectBtn.tag = 30000;
    _centerSelectBtn.hidden = YES;
    _rightSelectBtn.hidden = YES;
    self.locatePicker = [[HZAreaPickerView alloc] initWithStyle:HZAreaPickerWithStateAndCityAndDistrict delegate:self];
    [self.locatePicker valueOfCurrentStr:^(NSString *currentStr) {
        _locationLabel.text = currentStr;
    }];
}
#pragma  mark- 单选按钮方法
- (void)didSelectedRadioButton:(QRadioButton *)radio groupId:(NSString *)groupId
{
    _sex = radio.titleLabel.text;
    NSLog(@"%@", self.sex);
}
- (IBAction)ageBtnAction:(id)sender {
    JSPickerView *picker = [JSPickerView pickerViewInstance];
    NSMutableArray *mArray = [[NSMutableArray alloc] init];
    for (int i = 0; i < 110; i ++) {
        [mArray addObject:[NSString stringWithFormat:@"%d岁", i]];
    }
    picker.firstMArr = mArray;
    [picker valueOfCurrentStr:^(NSString *currentStr) {
        _ageLabel.text = currentStr;
    }];
    [picker showInView:self.view];
    
}
//#pragma  mark- 确定地区位置方法
//-(void)pickerDidChaneStatus:(HZAreaPickerView *)picker
//{
//    [_selectLocationBtn setTitle:[NSString stringWithFormat:@"%@ %@ %@", picker.locate.state, picker.locate.city, picker.locate.district] forState:UIControlStateNormal];
//}
-(void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event
{
    [super touchesBegan:touches withEvent:event];
    [_textView resignFirstResponder];
    [self.locatePicker cancelPicker];
}
#pragma  mark- 开始编辑方法
-(BOOL)textViewShouldBeginEditing:(UITextView *)textView
{
    _placeholderLabel.hidden =  YES;
    return YES;
    
}
#pragma  mark- textView 回收键盘
-(BOOL)textView:(UITextView *)textView shouldChangeTextInRange:(NSRange)range replacementText:(NSString *)text
{
    if ([@"\n" isEqualToString:text] == YES) {
        [textView resignFirstResponder];
        if ([textView.text isEqualToString:@""]) {
            _placeholderLabel.hidden = NO;
        }
        return NO;
    }
    return YES;
}
#pragma  mark- return收回键盘
-(BOOL)textFieldShouldReturn:(UITextField *)textField
{
    NSInteger age = [textField.text integerValue];
    NSLog(@"%ld", (long)age);
    if (1<age && age < 110) {
        NSLog(@"%@", textField.text);
    } else {
        DXAlertView *alertView = [[DXAlertView alloc] initWithTitle:@"糖尿病护士提醒" contentText:@"请输入正确的年龄" leftButtonTitle:nil rightButtonTitle:@"好"];
        [alertView show];
    }
    [_textField resignFirstResponder];
    return YES;
    
}
#pragma  mark- 弹出选择照片方式方法
- (IBAction)leftSelectBtnAction:(UIButton *)sender {
    
    if (sender.tag ==10000) {
        _buttonNum = 10000;
    } else if (sender.tag == 20000){
        _buttonNum = 20000;
    } else if (sender.tag == 30000) {
        _buttonNum = 30000;
    }
    UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:@"选择选图方式" delegate:self cancelButtonTitle:@ "取消" destructiveButtonTitle:nil otherButtonTitles:@"照相机", @"从相册", nil];
    actionSheet.tag = 11111;
    [actionSheet showInView:self.view];
}

-(void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (actionSheet.tag ==  11111) {
        if (buttonIndex == 1) {
            
            ELCImagePickerController *picker = [[ELCImagePickerController alloc] initImagePicker];
            if ([_leftSelectBtn currentImage] && [_centerSelectBtn currentImage] && [_rightSelectBtn currentImage]) {

                picker.maximumImagesCount = 1;
            } else if ([_leftSelectBtn currentImage] && [_centerSelectBtn currentImage]){
                picker.maximumImagesCount = 2;
                
            } else if ([_leftSelectBtn currentImage]) {
                picker.maximumImagesCount = 3;
            }
            else {
                picker.maximumImagesCount = 3;
            }
            picker.returnsOriginalImage = YES;
            picker.returnsImage = YES;
            picker.onOrder = YES;
            picker.mediaTypes = @[(NSString *)kUTTypeImage];
            picker.imagePickerDelegate = self;
            [self presentViewController:picker animated:YES completion:nil];
        }else if (buttonIndex == 0){
            UIImagePickerController *picker = [[UIImagePickerController alloc] init];
            picker.sourceType = UIImagePickerControllerSourceTypeCamera;
            picker.delegate = self;
            [self presentViewController:picker animated:YES completion:nil];
        }
    }
}
#pragma  mark- UIImagePickerController 
- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingImage:(UIImage *)image editingInfo:(NSDictionary *)editingInfo
{
    NSLog(@"%@", editingInfo);
    if (_buttonNum == 10000) {
        [_leftSelectBtn setImage:image forState:UIControlStateNormal];
    } else if (_buttonNum == 20000){
        [_centerSelectBtn setImage:image forState:UIControlStateNormal];
        
    } else if (_buttonNum == 30000){
        [_rightSelectBtn setImage:image forState:UIControlStateNormal];
    }
        [self dismissViewControllerAnimated:YES completion:nil];
}
#pragma  mark- 照片返回方法
-(void)elcImagePickerControllerDidCancel:(ELCImagePickerController *)picker
{
    [self dismissViewControllerAnimated:YES completion:nil];
}
-(void)elcImagePickerController:(ELCImagePickerController *)picker didFinishPickingMediaWithInfo:(NSArray *)info
{
    NSLog(@"%@", info);
    if (info.count == 1) {
        if (_buttonNum == 10000) {
            [_leftSelectBtn  setImage:[[info objectAtIndex:0] objectForKey:@"UIImagePickerControllerOriginalImage"] forState:UIControlStateNormal];
            _leftSelectBtn.hidden = NO;
            _centerSelectBtn.hidden = NO;
        } else if (_buttonNum == 20000){
            [_centerSelectBtn  setImage:[[info objectAtIndex:0] objectForKey:@"UIImagePickerControllerOriginalImage"] forState:UIControlStateNormal];
            _centerSelectBtn.hidden = NO;
            _rightSelectBtn.hidden = NO;
        } else if (_buttonNum == 30000){
            [_rightSelectBtn  setImage:[[info objectAtIndex:0] objectForKey:@"UIImagePickerControllerOriginalImage"] forState:UIControlStateNormal];
            _rightSelectBtn.hidden = NO;
            
        }
    } else {
        
        for (int i = 0; i < info.count; i ++) {
            if (i == 0) {
                [_leftSelectBtn setImage:[[info objectAtIndex:i] objectForKey:@"UIImagePickerControllerOriginalImage"] forState:UIControlStateNormal];
                _leftSelectBtn.hidden = NO;
            }
            if (i == 1) {
                [_centerSelectBtn  setImage:[[info objectAtIndex:i] objectForKey:@"UIImagePickerControllerOriginalImage"] forState:UIControlStateNormal];
                _centerSelectBtn.hidden = NO;
            }
            if (i == 2) {
                [_rightSelectBtn  setImage:[[info objectAtIndex:i] objectForKey:@"UIImagePickerControllerOriginalImage"] forState:UIControlStateNormal];
                _rightSelectBtn.hidden = NO;
            }
        }
    }
    [self dismissViewControllerAnimated:YES completion:nil];
}

#pragma  mark-  点击选择发布位置按钮
- (IBAction)selectLoctionBtnAction:(id)sender {
  
    [self.locatePicker showInView:self.view];
    
}

- (IBAction)issueAction:(id)sender {
    User *user = [User shareInstance];
    if (user.member_uid) {
        //可以发布
        [self sendQuestionToServer];
    } else {
        DXAlertView *alertView =[[DXAlertView alloc] initWithTitle:nil contentText:@"您还没有登录,登录后会有惊喜哦" leftButtonTitle:@"取消" rightButtonTitle:@"去登录"];
        [alertView show];
        alertView.rightBlock = ^(){
            UIStoryboard *loginSB = [UIStoryboard storyboardWithName:@"Mine" bundle:nil];
            LoginViewController *loginVC =[loginSB instantiateViewControllerWithIdentifier:@"login"];
            [self presentViewController:loginVC animated:YES completion:nil];
            
        };
    }
}
#pragma  mark- 发布问题方法
-(void)sendQuestionToServer
{
    if ([_locationLabel.text isEqualToString:@""]) {
        DXAlertView *alertView = [[DXAlertView alloc] initWithTitle:nil contentText:@"请选择发布位置" leftButtonTitle:nil rightButtonTitle:@"去选择"];;
        [alertView show];
        return;
    }
    if ([_ageLabel.text isEqualToString:@""]) {
        DXAlertView *alertView = [[DXAlertView alloc] initWithTitle:nil contentText:@"请选择年龄" leftButtonTitle:nil rightButtonTitle:@"去选择"];;
        [alertView show];
        return;
    }
    if ([_textView.text isEqualToString:@""]) {
        DXAlertView *alertView = [[DXAlertView alloc] initWithTitle:nil contentText:@"请填写详细症状" leftButtonTitle:nil rightButtonTitle:@"去填写"];;
        [alertView show];
        return;
    }
    LoginState *loginState = [[LoginState alloc] init];
    [loginState loginStateWithViewController:self];
    Question *question = [[Question alloc] init];
    [FVCustomAlertView showDefaultLoadingAlertOnView:self.view withTitle:@"上传中..."];
    NSMutableDictionary *dic = [[NSMutableDictionary alloc] init];
    [dic setObject:_locationLabel.text forKey:@"location"];
    [dic setObject:_textView.text  forKey:@"content"];
    [dic setObject:_sex forKey:@"sex"];
    [dic setObject:_ageLabel.text forKey:@"age"];
    //向医生提问
    if (self.isDoctor==YES) {
        [dic setObject:self.doctor.uid forKey:@"touid"];
    }
    NSArray *array = [NSArray arrayWithObjects:_leftSelectBtn.currentImage, _centerSelectBtn.currentImage, _rightSelectBtn.currentImage, nil];
//    [dic setObject:array forKey:@"images"];
    [question setValuesForKeysWithDictionary:dic];
    question.images = array;
    NSLog(@"%@", dic);
    NSMutableArray *imageMarr = [[NSMutableArray alloc] init];
    for (int i = 0; i < array.count; i++) {
        NSData *imageData = UIImageJPEGRepresentation(array[i], 0.0001);
        [imageMarr addObject:imageData];
    }
    AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
    manager.responseSerializer.acceptableContentTypes = [NSSet setWithObject:@"text/html"];
#warning 测试服务器  正式需改
    [manager POST:@"http://test.tanghushi.com/api/mobile/?version=2&module=question&op=add" parameters:dic constructingBodyWithBlock:^(id<AFMultipartFormData> formData) {
        if (imageMarr.count > 0) {
            for (int i = 0; i < imageMarr.count; i++) {
                [formData appendPartWithFileData:imageMarr[i] name:[NSString stringWithFormat:@"image%d",i] fileName:[NSString stringWithFormat:@"image%d.jpeg",i] mimeType:@"image/jpeg"];
            }
        }
    } success:^(AFHTTPRequestOperation *operation, id responseObject) {
        NSLog(@"%@", responseObject);
        if ([[responseObject objectForKey:@"Variables"] objectForKey:@"value"]) {
            question.qid = [[responseObject objectForKey:@"Variables"] objectForKey:@"value"];
            [FVCustomAlertView hideAlertFromView:self.view fading:YES];
            UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"MyQuestion" bundle:[NSBundle mainBundle]];
            MyQuestionDetailViewController *controller = [storyboard instantiateViewControllerWithIdentifier:@"MyQuestionDetailViewController"];
            controller.question = question;
            _textView.text = @"";
            _centerSelectBtn.hidden = YES;
            _rightSelectBtn.hidden = YES;
            [_leftSelectBtn setImage:nil forState:UIControlStateNormal];
            [_centerSelectBtn setImage:nil forState:UIControlStateNormal];
            [_rightSelectBtn setImage:nil forState:UIControlStateNormal];
            [self.navigationController pushViewController:controller animated:YES];
//            DXAlertView *alertView =[[DXAlertView alloc] initWithTitle:nil contentText:@"发布成功，请耐心等待回答" leftButtonTitle:nil rightButtonTitle:@"好"];
//            [alertView show];
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        NSLog(@"%@", error);
    }];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
