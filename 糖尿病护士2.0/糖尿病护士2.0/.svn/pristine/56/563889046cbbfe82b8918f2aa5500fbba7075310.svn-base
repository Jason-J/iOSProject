//
//  PayViewController.m
//  TangNiaoBingHuShi
//
//  Created by qimingfang-dwk on 14/12/25.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "PayViewController.h"
#import "Pay.h"
#import "GTMBase64.h"
#import "AilPayWebView.h"


@interface PayViewController ()<UITableViewDataSource,UITableViewDelegate>{
    BOOL isBuy;
}

@property (nonatomic,strong)UITableView * tableView;
@property (nonatomic,strong)Pay * headerView;

@end

@implementation PayViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [self.view setBackgroundColor:[UIColor colorWithRed:236.0/255 green:246.0/255 blue:246.0/255 alpha:1]];
    self.tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT) style:UITableViewStyleGrouped];
    self.tableView.delegate = self;
    self.tableView.dataSource = self;
    [self.view addSubview:self.tableView];
    self.tableView.backgroundColor = [UIColor colorWithRed:236.0/255 green:246.0/255 blue:246.0/255 alpha:1];
    
    self.headerView = [[[NSBundle mainBundle] loadNibNamed:@"Pay" owner:self options:nil] lastObject];
    
    self.tableView.tableHeaderView = self.headerView;
    
    self.headerView.nameLab.text = self.name;
    self.headerView.priceLab.text = self.consult;
    [self.headerView.buyBtn addTarget:self action:@selector(buyAction:) forControlEvents:UIControlEventTouchUpInside];
    self.tableView.separatorInset = UIEdgeInsetsMake(0, 0, 0, 0);
    isBuy=NO;
}
#pragma mark - buyAction
-(void)buyAction:(id)sender{
    if (isBuy==YES) {
        [FVCustomAlertView showDefaultDoneAlertOnView:self.view withTitle:@"已购买"];
    }else{
        [self.headerView.buyBtn setBackgroundImage:[UIImage imageNamed:@"bind-button"] forState:UIControlStateNormal];
        isBuy =YES;
    }
}
#pragma mark -tableviewdelegate
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return 0;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return 3;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
   static NSString * ce = @"11";
    UITableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:ce];
    
    if (!cell) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:ce];
    }
    if (indexPath.row==0) {
        cell.textLabel.text = @"选择支付方式";
        cell.userInteractionEnabled = NO;
    }else if (indexPath.row==1){
        cell.textLabel.text = @"账号余额支付";
        cell.imageView.image = [UIImage imageNamed:@"binding_balance"];
    }else{
        cell.textLabel.text = @"支付宝";
        cell.imageView.image = [UIImage imageNamed:@"binding_pay"];
    }
    return cell;
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.row==2) {
        DXAlertView * alert = [[DXAlertView alloc] initWithTitle:@"提示" contentText:@"确定使用支付宝购买？" leftButtonTitle:@"取消" rightButtonTitle:@"确定"];
        [alert show];
        alert.rightBlock = ^(){
            NSLog(@"支付宝支付");
            [self getOrderIDRequest];
        };
    }else if (indexPath.row ==1){
        DXAlertView * alert = [[DXAlertView alloc] initWithTitle:@"提示" contentText:@"确定使用余额购买？" leftButtonTitle:@"取消" rightButtonTitle:@"确定"];
        [alert show];
        alert.rightBlock = ^(){
            if ([self.balance floatValue]>=[self.consult_money floatValue]) {
                [self buyForBlanceRequest];
            } else{
                [FVCustomAlertView showDefaultWarningAlertOnView:self.view withTitle:@"余额不足!"];
            }
        };
    }
}
#pragma mark -余额购买
- (void)buyForBlanceRequest{
    JSNetWorking * js = [[JSNetWorking alloc] init];
    NSDictionary * dic =@{@"degree":@"5",@"money":self.consult_money,@"uid":self.uid};
    [js postRequestWithURLStr:@"http://test.tanghushi.com/api/mobile/?version=2&module=account&op=consult" paramters:dic success:^(id ResultData) {
        id value = [[ResultData objectForKey:@"Variables"] objectForKey:@"value"];
        NSLog(@"value = %@",value);
        if ([value intValue]==1) {
            [FVCustomAlertView showDefaultDoneAlertOnView:self.view withTitle:@"购买成功"];
        }
    } failure:^(NSError *error, AFHTTPRequestOperation *operation) {
        NSLog(@"购买失败%@",error);
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"购买失败"];
    }];
}
#pragma mark - request
- (void)getOrderIDRequest{
    JSNetWorking * js = [[JSNetWorking alloc] init];
    NSString * url = [CommonSettings baseUrlWithVersion:2 module:@"account" parameters:@{@"op":@"get_orderid"}];
    NSDictionary * paramterDic = @{@"uid":self.uid,@"balance":@"0",@"card_type":@"consult",@"total_fee":self.consult_money,@"count":@"5"};
    [js postRequestWithURLStr:url paramters:paramterDic success:^(id ResultData) {
        id value = [[ResultData objectForKey:@"Variables"] objectForKey:@"value"];
        NSLog(@"value=%@",value);
        if (value) {
            [self alipayRequest:value];
        }
    } failure:^(NSError *error, AFHTTPRequestOperation *operation) {
        NSLog(@"生成订单失败,error=%@",error);
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"错误"];
    }];
}
- (void)alipayRequest:(NSString *)order{
    //加密
    NSString * widout_trade_no = [NSString stringWithURLEncoding:[GTMBase64 encodeBase64String:order]];
    NSString * widsubject = [NSString stringWithURLEncoding:[GTMBase64 encodeBase64String:@"图文咨询"]];
    NSString * widtotal_fee = [NSString stringWithURLEncoding:[GTMBase64 encodeBase64String:@"0.01"]];
    NSString * url = [NSString stringWithFormat:@"http://test.tanghushi.com/api/alipay/receive.php?WIDout_trade_no=%@&WIDsubject=%@&WIDtotal_fee=%@",widout_trade_no,widsubject,widtotal_fee];
    AilPayWebView * ailpayVC = [[AilPayWebView alloc] init];
    ailpayVC.url = url;
    [self.navigationController pushViewController:ailpayVC animated:YES];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end


