//
//  CellForAlarmClock.m
//  TangNiaoBingHuShi
//
//  Created by Jason on 14-11-24.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "CellForAlarmClock.h"

@implementation CellForAlarmClock

- (void)awakeFromNib {
    // Initialization code
    _myImageView.backgroundColor = [UIColor grayColor];

    
}
-(void)setAlarmClock:(AlarmClock *)alarmClock
{
    if (_alarmClock!= alarmClock) {
        _alarmClock = alarmClock;
    }
    if ([alarmClock.alarmType isEqualToString:@"1"]) {
        _mySwitch.hidden = YES;
        _sportTimeLabel.hidden = YES;
        _myTitle.text = alarmClock.checkProject;
        _myContent.text = [NSString stringWithFormat:@"下次检查时间%@", alarmClock.time];
    } else if ([alarmClock.alarmType isEqualToString:@"2"]){
        _sportTimeLabel.hidden = NO;
        _sportTimeLabel.text = alarmClock.time;
        _myTitle.text = alarmClock.checkProject;
        _myContent.text = alarmClock.repeat;
    } else {
        _sportTimeLabel.hidden = YES;
        _myTitle.text = alarmClock.remarks;
        _myContent.text = alarmClock.time;
        _mySwitch.hidden = YES;
    }

    
    
}
- (IBAction)mySwichAction:(UISwitch *)swich {
    NSLog(@"%hhd", swich.on);
    NSLog(@"闹钟类型%@",_alarmClock.alarmType);
    
    if ([_alarmClock.alarmType isEqualToString:@"2"]) {
        if (swich.on) {
            
        }
    }
}
-(void)sportRemindAction:(AlarmClock *)alarmClock
{
    NSString *clockRemeber = alarmClock.remarks;
    NSString *clockTime = alarmClock.time;
    NSArray *clockTimeArray = [clockTime componentsSeparatedByString:@":"];
    NSDate *dateNow = [NSDate date];
    NSCalendar *calendar = [[NSCalendar alloc] initWithCalendarIdentifier:NSGregorianCalendar];
    NSDateComponents *comps = [[NSDateComponents alloc] init] ;
    //    [calendar setTimeZone:[NSTimeZone timeZoneWithName:@"GMT"]];
    //    [comps setTimeZone:[NSTimeZone timeZoneWithName:@"CMT"]];
    NSInteger unitFlags = NSEraCalendarUnit |
    NSYearCalendarUnit |
    NSMonthCalendarUnit |
    NSDayCalendarUnit |
    NSHourCalendarUnit |
    NSMinuteCalendarUnit |
    NSSecondCalendarUnit |
    NSWeekCalendarUnit |
    NSWeekdayCalendarUnit |
    NSWeekdayOrdinalCalendarUnit |
    NSQuarterCalendarUnit;
    
    comps = [calendar components:unitFlags fromDate:dateNow];
    [comps setHour:[[clockTimeArray objectAtIndex:0] intValue]];
    [comps setMinute:[[clockTimeArray objectAtIndex:1] intValue]];
    [comps setSecond:0];
    
    //------------------------------------------------------------------------
    Byte weekday = [comps weekday];
    NSMutableArray *array = [[NSMutableArray alloc] init];
    if ([alarmClock.Monday isEqualToString:@"1"]) {
        [array addObject:@"一"];
    }
    if ([alarmClock.Tuesday isEqualToString:@"1"])  {
        [array addObject:@"二"];
    }
    if ([alarmClock.Wednesday isEqualToString:@"1"]) {
        [array addObject:@"三"];
    }
    if ([alarmClock.Thursday isEqualToString:@"1"]) {
        [array addObject:@"四"];
    }
    if ([alarmClock.Friday isEqualToString:@"1"]) {
        [array addObject:@"五"];
    }
    if ([alarmClock.Saturday isEqualToString:@"1"]) {
        [array addObject:@"六"];
    }
    if ([alarmClock.Sunday isEqualToString:@"1"]) {
        [array addObject:@"日"];
    }
    
    //	NSArray *array = [[clockMode substringFromIndex:1] componentsSeparatedByString:@"、"];
    Byte i = 0;
    Byte j = 0;
    int days = 0;
    int	temp = 0;
    Byte count = [array count];
    Byte clockDays[7];
    
    NSArray *tempWeekdays = [NSArray arrayWithObjects:@"日", @"一", @"二", @"三", @"四", @"五", @"六", nil];
    //查找设定的周期模式
    for (i = 0; i < count; i++) {
        for (j = 0; j < 7; j++) { 			if ([[array objectAtIndex:i] isEqualToString:[tempWeekdays objectAtIndex:j]]) {
            clockDays[i] = j + 1;
            break;
        }
        }
    }
    
    for (i = 0; i < count; i++) {
        temp = clockDays[i] - weekday;
        days = (temp >= 0 ? temp : temp + 7);
        NSDate *newFireDate = [[calendar dateFromComponents:comps] dateByAddingTimeInterval:3600 * 24 * days];
        
        
        NSTimeInterval time= 	[newFireDate timeIntervalSinceDate:dateNow];
        [newFireDate dateByAddingTimeInterval:10];
        
        NSLog(@"----- %f", time);
        UILocalNotification *newNotification = [[UILocalNotification alloc] init];
        if (newNotification) {
            newNotification.fireDate = [dateNow dateByAddingTimeInterval:time];
            newNotification.alertBody = clockRemeber;
            newNotification.alertAction = clockRemeber;
            newNotification.soundName = UILocalNotificationDefaultSoundName;
            newNotification.timeZone = [NSTimeZone defaultTimeZone];
            newNotification.alertAction = @"查看闹钟";
            newNotification.repeatInterval = NSWeekCalendarUnit;
            NSDictionary *userInfo = [NSDictionary dictionaryWithObject:alarmClock.checkProject forKey:@"alarmClock2"];
            newNotification.userInfo = userInfo;
            newNotification.applicationIconBadgeNumber = 1;
            [[UIApplication sharedApplication] scheduleLocalNotification:newNotification];
        }
        NSLog(@"Post new localNotification:%@", [newNotification fireDate]);
        
        
    }

}
- (void)setSelected:(BOOL)selected animated:(BOOL)animated {
    [super setSelected:selected animated:animated];

    // Configure the view for the selected state
}

@end
