//
//  SubjectsDetailsViewController.m
//  TangNiaoBingHuShi
//
//  Created by qimingfang-dwk on 14/11/27.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "SubjectsDetailsViewController.h"
#import "AFNetworking.h"
#import "Subjects.h"
#import "UIImageView+WebCache.h"
#import "CommentTableViewCell.h"
#import "collectBtn.h"
#import "FVCustomAlertView.h"
enum{
    sizeOfs,
    sizeOfm,
    sizeOfb,
    
};
 int stateOfFont =00;
@interface SubjectsDetailsViewController ()<UITableViewDelegate,UITableViewDataSource,UITextFieldDelegate>{
    UILabel * _commentLabel;
    UIView * view;
    UILabel * titleLab;   //文章标题
    UILabel * timeLab;    //文章发表时间
    UILabel * contentLab;  //文章内容
    UITextField * _say;
    UIView * vieww;
    UIImageView * image;
}
@property (nonatomic,strong)NSString * message;

@end

@implementation SubjectsDetailsViewController

- (void)viewDidLoad {
    [super viewDidLoad];
        // Do any additional setup after loading the view.
    self.navigationController.navigationBar.translucent = YES;
    _tableArray = [[NSMutableArray alloc] init];
    [self request];
    _tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, view.frame.size.height+64, SCREEN_WIDTH, self.view.frame.size.height-64) style:UITableViewStyleGrouped];
    _tableView.rowHeight = 140;
    [self.view addSubview:_tableView];

    _tableView.delegate = self;
    _tableView.dataSource = self;
    if (self.aid==nil) {
        
        [self AsyncComment];
    } else if (self.aaid ==nil){
        
//        [self request];
        _commentLabel.hidden = YES;
    }
    [self fontSet];
  
    collectBtn * fontBtn = [[collectBtn alloc]init];
    [fontBtn setTitle:@"文字" forState:UIControlStateNormal];
//    [fontBtn setBackgroundColor:[UIColor redColor]];
    [fontBtn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    UIBarButtonItem * button1 = [[UIBarButtonItem alloc] initWithCustomView:fontBtn];
    [fontBtn addTarget:self action:@selector(changeFontSizeAction:) forControlEvents:UIControlEventTouchUpInside];
    
    collectBtn * collectBt = [[collectBtn alloc] init];
    [collectBt setTitle:@"收藏" forState:UIControlStateNormal];
//    [collectBt setBackgroundColor:[UIColor blueColor]];
    [collectBt setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    UIBarButtonItem * button2 = [[UIBarButtonItem alloc] initWithCustomView:collectBt];
    [collectBt addTarget:self action:@selector(collectAction:) forControlEvents:UIControlEventTouchUpInside];
    
    collectBtn * shareBtn = [[collectBtn alloc] init];
    [shareBtn setTitle:@"分享" forState:UIControlStateNormal];
//    [shareBtn setBackgroundColor:[UIColor purpleColor]];
    [shareBtn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    UIBarButtonItem * button3 =[[UIBarButtonItem alloc] initWithCustomView:shareBtn];
    self.navigationItem.rightBarButtonItems = @[button3,button2,button1];
}
-(void)viewDidAppear:(BOOL)animated{
    
}
#pragma mark - 改变字体
- (void)changeFontSizeAction:(id)sender{
    [self request];
    if (contentLab.tag==sizeOfs) {
        [contentLab setFont:[UIFont fontWithName:nil size:20]];
        stateOfFont=01;
        [self fontSet];
    } else if (contentLab.tag==sizeOfm){
        [contentLab setFont:[UIFont fontWithName:nil size:23]];
        stateOfFont=02;
        [self fontSet];
    }else if (contentLab.tag==sizeOfb){
        [contentLab setFont:[UIFont fontWithName:nil size:17]];
        stateOfFont=00;
        [self fontSet];
    }
}
- (void)fontSet{
    if (stateOfFont==00) {
        [contentLab setFont:[UIFont fontWithName:nil size:17]];
        contentLab.tag=sizeOfs;
    } else if (stateOfFont==01){
        [contentLab setFont:[UIFont fontWithName:nil size:20]];
        contentLab.tag=sizeOfm;
    } else if (stateOfFont==02){
        [contentLab setFont:[UIFont fontWithName:nil size:23]];
        contentLab.tag=sizeOfb;
    }
}
#pragma mark -收藏
- (void)collectAction:(id)sender{
    JSNetWorking * js = [[JSNetWorking alloc] init];
    NSString * url = [NSString stringWithFormat:@"http://test.tanghushi.com/api/mobile/?version=2&module=wiki&op=favorite&aid=%@",self.aaid];
    [js getRequestWithURLStr:url success:^(id ResultData) {
        id value = [[ResultData objectForKey:@"Variables"] objectForKey:@"value"];
        NSLog(@"value=-==-=-==-=-=--=-=-==-=-=%@",value);
        if ([value isEqualToNumber:[NSNumber numberWithInt:1]]) {
            [FVCustomAlertView showDefaultDoneAlertOnView:self.view withTitle:@"收藏成功"];
        } else if ([value isEqualToNumber:[NSNumber numberWithInt:0]]){
            [FVCustomAlertView showDefaultWarningAlertOnView:self.view withTitle:@"您已经收藏过了"];
        }
    } failure:^(NSError *error, AFHTTPRequestOperation *operation) {
        NSLog(@"error ====%@",error);
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"收藏失败"];
    }];
}
#pragma mark - 请求
-(void)request{
    [FVCustomAlertView showDefaultLoadingAlertOnView:self.view withTitle:@"请等待"];
    NSURL *url = [NSURL URLWithString:[NSString stringWithFormat:@"http://test.tanghushi.com/api/mobile/?version=2&module=wiki&aid=%@",self.aaid]];
    //    NSMutableString * string = [NSMutableString stringWithFormat:
    NSURLRequest * request = [[NSURLRequest alloc]initWithURL:url cachePolicy:NSURLRequestReloadIgnoringCacheData timeoutInterval:20];
    
    AFHTTPRequestOperation * operation = [[AFHTTPRequestOperation alloc] initWithRequest:request];
    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
        NSString *requestTmp = [NSString stringWithString:operation.responseString];
        NSData *resData = [[NSData alloc] initWithData:[requestTmp dataUsingEncoding:NSUTF8StringEncoding]];
        
        id object = [NSJSONSerialization JSONObjectWithData:resData options:NSJSONReadingMutableLeaves error:nil];
        NSDictionary * value = [[object objectForKey:@"Variables"] objectForKey:@"value"];
        NSLog(@"aid===-=------------------------=%@",self.aaid);
        Subjects * subjects = [[Subjects alloc] init];
        subjects.title = [value objectForKey:@"title"];
        subjects.content = [value objectForKey:@"content"];
        subjects.dateline = [value objectForKey:@"dateline"];
        subjects.contentIma = [value objectForKey:@"iamges"];
        
        view = [[UIView alloc] init];
        [self.view addSubview:view];
        
        [titleLab setFont:[UIFont fontWithName:nil size:16]];
        [titleLab setBackgroundColor:[UIColor blackColor]];
        titleLab = [[UILabel alloc] init];
        
        [titleLab setTextAlignment:NSTextAlignmentCenter];
        titleLab.text = subjects.title;
        [view addSubview:titleLab];
        
        timeLab = [[UILabel alloc] init];
        
        NSString * str = [NSString stringWithFormat:@"糖护士 · %@",subjects.dateline];
        [timeLab setText:str];
        [timeLab setTextColor:[UIColor grayColor]];
        
        [timeLab setFont:[UIFont fontWithName:nil size:13]];
        
        [view addSubview:timeLab];
        image = [[UIImageView alloc]init];
        [image sd_setImageWithURL:[NSURL URLWithString:subjects.images] placeholderImage:[UIImage imageNamed:@"girl4.png"]];
        [view addSubview:image];
        
        contentLab = [[UILabel alloc] init];
        [view addSubview:contentLab];
        
        _commentLabel = [[UILabel alloc] init];
        
        
        [titleLab setFrame:CGRectMake(10, 10, 300, 40)];
        [timeLab setFrame:CGRectMake(5, 50, 200, 20)];
        [image setFrame:CGRectMake(10, 50+timeLab.frame.size.height+20, 300, 100)];
        [contentLab  setFrame:CGRectMake(5, image.frame.origin.y+image.frame.size.height+5, 310, 0)];
        [contentLab setBackgroundColor:[UIColor whiteColor]];
        [contentLab setNumberOfLines:0];
        [contentLab setTextColor:[UIColor grayColor]];
        
        [contentLab setText:[self removeHTML:subjects.content]];
        [self fontSet];
        [contentLab sizeToFit];
     
  
    
        [_commentLabel  setFrame:CGRectMake(5, contentLab.frame.size.height+80, 320, 40)];


        [view setFrame:CGRectMake(0, 0, 320, 80+contentLab.frame.size.height+_commentLabel.frame.size.height+image.frame.size.height)];

       _tableView.tableHeaderView = view;
        NSLog(@"titleH===%fcon-=%f",titleLab.frame.size.height,contentLab.frame.size.height);
        vieww = [[UIView alloc] init];
        [vieww setFrame:CGRectMake(0, self.view.frame.size.height-40, 320, 40)];
        vieww.backgroundColor = [UIColor grayColor];
        vieww.userInteractionEnabled = YES;
        [self.view addSubview:vieww];
        
        _say = [[UITextField alloc] init];
        
        _say.backgroundColor = [UIColor whiteColor];
        _say.delegate = self;
        _say.placeholder = @"请输入想说的内容";
        self.message = _say.text;

        [vieww addSubview:_say];
        
        UIButton * huifu = [UIButton buttonWithType:UIButtonTypeCustom];
        
        [huifu addTarget:self action:@selector(sendAction:) forControlEvents:UIControlEventTouchUpInside];
        [huifu setBackgroundImage:[UIImage imageNamed:@"fas.png"] forState:UIControlStateNormal];
        huifu.backgroundColor = [UIColor whiteColor];
        [huifu setTitle:@"发送" forState:UIControlStateNormal];
        [huifu setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
        [_say setFrame:CGRectMake(5, 5, 255, 30)];
        huifu.frame = CGRectMake(265, 5, 50, 30);
        [vieww addSubview:huifu];
        [FVCustomAlertView hideAlertFromView:self.view fading:YES];
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if (error) {
            NSLog(@"error ==%@",error);
        }
    }];
    [operation start];

}
- (void)sendAction:(id)sender{
    [self sendMessage];
    
}
- (void)sendMessage{
    NSURL *url = [NSURL URLWithString:[NSString stringWithFormat:@"http://test.tanghushi.com/api/mobile/?version=2&module=wiki&op=reply&aid=%@&message=%@",self.aaid,_say.text]];
    //    NSMutableString * string = [NSMutableString stringWithFormat:
    NSURLRequest * request = [[NSURLRequest alloc]initWithURL:url cachePolicy:NSURLRequestReloadIgnoringCacheData timeoutInterval:20];
    
    AFHTTPRequestOperation * operation = [[AFHTTPRequestOperation alloc] initWithRequest:request];
    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
        NSString *requestTmp = [NSString stringWithString:operation.responseString];
        NSData *resData = [[NSData alloc] initWithData:[requestTmp dataUsingEncoding:NSUTF8StringEncoding]];
        
        id object = [NSJSONSerialization JSONObjectWithData:resData options:NSJSONReadingMutableLeaves error:nil];
        id mess = [[[object objectForKey:@"Variables"] objectForKey:@"value"] objectForKey:@"mess"];
        
        if ([mess isEqualToString:@"回复成功"]) {
            DXAlertView * messAle = [[DXAlertView alloc]initWithTitle:@"提示：" contentText:@"回复成功！" leftButtonTitle:nil rightButtonTitle:@"确定"];
            messAle.rightBlock=^(){
                [self AsyncComment];
            };
            [messAle show];
        }else{
            DXAlertView * messAle = [[DXAlertView alloc] initWithTitle:@"提示：" contentText:@"回复失败" leftButtonTitle:nil rightButtonTitle:@"确定"];
            [messAle show];
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if (error) {
            NSLog(@"error ==%@",error);
            [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"回复失败"];
        }
    }];
    [operation start];

}
#pragma mark - 网络请求（评论）
- (void)AsyncComment{
    NSString * string = [NSString stringWithFormat:@"http://test.tanghushi.com/api/mobile/?version=2&module=wiki&op=replylist&p=1&aid=%@",self.aaid];
    NSLog(@"url ===%@",string);
    NSURL *url = [NSURL URLWithString:string];
    NSURLRequest * request = [[NSURLRequest alloc]initWithURL:url cachePolicy:NSURLRequestReloadIgnoringCacheData timeoutInterval:20];
    AFHTTPRequestOperation * operation = [[AFHTTPRequestOperation alloc] initWithRequest:request];
    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
        NSString *requestTmp = [NSString stringWithString:operation.responseString];
        NSData *resData = [[NSData alloc] initWithData:[requestTmp dataUsingEncoding:NSUTF8StringEncoding]];
        
        id object = [NSJSONSerialization JSONObjectWithData:resData options:NSJSONReadingMutableLeaves error:nil];
        id array = [[object objectForKey:@"Variables"] objectForKey:@"value"];
        [_tableArray removeAllObjects];
//            SubjectModel * model = [[SubjectModel alloc] init];
        for (NSDictionary * dic in array) {
            //把model数据存入数组
            [_tableArray addObject:dic];
            [_tableView reloadData];
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if (error) {
            NSLog(@"error ==%@",error);
            [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"错误"];
        }
    }];
    [operation start];
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    
    return _tableArray.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    static NSString * ce = @"id";
    CommentTableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:ce];
    if (!cell) {
        cell = [[CommentTableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:ce];
    }
    //显示到cell上
    NSDictionary * dic = [_tableArray objectAtIndex:indexPath.row];
    cell.name.text = [dic objectForKey:@"username"];
    cell.time.text = [dic objectForKey:@"dateline"];
    cell.comment.text = [dic objectForKey:@"message"];
    NSString * conmmentNum = [NSString stringWithFormat:@"  ---全部评论（%lu）",(unsigned long)_tableArray.count];
    [_commentLabel setText:conmmentNum];
    [cell.image sd_setImageWithURL:[NSURL URLWithString:[dic objectForKey:@"headimg"]] placeholderImage:[UIImage imageNamed:@"wode1_06.png"]];
    
    return cell;
}

#pragma mark - 过滤html标签
- (NSString *)removeHTML:(NSString *)html {
    
    NSScanner *theScanner;
    
    NSString *text = nil;
    
    
    
    theScanner = [NSScanner scannerWithString:html];
    
    
    
    while ([theScanner isAtEnd] == NO) {
        
        // find start of tag
        
        [theScanner scanUpToString:@"<" intoString:NULL] ;
        
        // find end of tag
        
        [theScanner scanUpToString:@">" intoString:&text] ;
        
        
        // replace the found tag with a space
        
        //(you can filter multi-spaces out later if you wish)
        
        html = [html stringByReplacingOccurrencesOfString:[NSString stringWithFormat:@"%@>", text] withString:@""];
        
    }
    
    NSString * newhtml = [html stringByReplacingOccurrencesOfString:@"&nbsp;" withString:@" "];
    NSString * httml = [newhtml stringByReplacingOccurrencesOfString:@"[attach]29364[/attach]" withString:@"   "];
    return httml;
    
}

- (NSString *)removeHTML2:(NSString *)html{
    
    NSArray *components = [html componentsSeparatedByCharactersInSet:[NSCharacterSet characterSetWithCharactersInString:@"<>"]];
    
    
    
    NSMutableArray *componentsToKeep = [NSMutableArray array];
    
    for (int i = 0; i < [components count]; i = i + 2) {
        
        [componentsToKeep addObject:[components objectAtIndex:i]];
        
    }

    NSString *plainText = [componentsToKeep componentsJoinedByString:@""];
    
    return plainText;
    
}
#pragma mark - 上弹键盘


-(void)textFieldDidBeginEditing:(UITextField *)textField{   //开始编辑时，整体上移
    
    [self moveView:-216-vieww.frame.size.height];
}
-(void)textFieldDidEndEditing:(UITextField *)textField{     //结束编辑时，整体下移
    
    [self moveView:216+vieww.frame.size.height];
}
-(void)moveView:(float)move{
    NSTimeInterval animationDuration = 0.30f;
    CGRect frame = self.view.frame;
    frame.origin.y +=move;//view的X轴上移
    self.view.frame = frame;
    [UIView beginAnimations:@"ResizeView" context:nil];
    [UIView setAnimationDuration: 1];
    [UIView setAnimationDuration:animationDuration];
    self.view.frame = frame;
    [UIView commitAnimations];//设置调整界面的动画效果
    [UIView setAnimationBeginsFromCurrentState:YES];
    
}
-(BOOL)textFieldShouldReturn:(UITextField *)textField{
    [textField resignFirstResponder];
    return  YES;
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
