//
//  PersonalCenter.m
//  TangNiaoBingHuShi
//
//  Created by qimingfang-dwk on 14/12/11.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "PersonalCenter.h"
#import "User.h"
#import "SecondViewController.h"
#import "HZAreaPickerView.h"
#import "FamilyController.h"
#import "MedicalRecordListViewController.h"


@interface PersonalCenter ()<UITableViewDataSource,UITableViewDelegate,HZAreaPickerDelegate>{
    UIView * footerView;
    NSString * sexStr;
    
    
    NSString * tnb;
    NSString * gxb;
    NSString * gxy;
    NSString * gxz;
    NSString * nxg;
}
@property (nonatomic,strong)UITableView * tableView;
@property (nonatomic,strong)NSMutableArray * tableArray;
@property (nonatomic,strong)NSMutableDictionary * dictionary;
@property (nonatomic,strong)HZAreaPickerView * locatePicker;
@end

@implementation PersonalCenter

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.tableArray = [[NSMutableArray alloc] init];
    self.dictionary = [[NSMutableDictionary alloc] init];
  
    User * user = [User shareInstance];
    
    
    NSString * sex = [NSString string];
    NSString *userRealNaem = !user.realname ? @"" : user.realname;
    [_tableArray addObject:@{@"image":@"", @"key":@"姓名", @"value":userRealNaem}];//0
    if ([user.gender intValue]==0) {
        sex = @"未知";
    } else if ([user.gender intValue]==1){
        sex = @"男";
    } else{
        sex = @"女";
    }
    [_tableArray addObject:@{@"image":@"",@"key":@"性别",@"value":sex}];//1
    NSString *userHeight = !user.height ? @"" : user.height;
    [_tableArray addObject:@{@"image":@"",@"key":@"身高",@"value":userHeight}];//2
    NSString *weight = !user.weight ? @"" : user.weight;
    [_tableArray addObject:@{@"image":@"",@"key":@"体重",@"value":weight}];//3
    NSString *idcard = !user.idcard ? @"" : user.idcard;
    [_tableArray addObject:@{@"image":@"",@"key":@"身份证号码",@"value":idcard}];//4
    NSString *field2 = !user.field2 ? @"" : user.field2;
    [_tableArray addObject:@{@"image":@"",@"key":@"确诊时间",@"value":field2}];//5
    NSString *field1 = !user.field1 ? @"" : user.field1;
    [_tableArray addObject:@{@"image":@"",@"key":@"确诊类型",@"value":field1}];//6
    NSString *resideprovince = !user.resideprovince ? @"" : user.resideprovince;
    [_tableArray addObject: @{@"image":@"",@"key":@"所在地",@"value":resideprovince}];//7
    [_tableArray addObject:@{@"image":@"",@"key":@"我的病历",@"value":@""}];//8
    
    if (![user.family_history isEqual:@""]) {
        
        for (NSDictionary *dic in user.family_history ) {
            if ([[dic objectForKey:@"item_name"] isKindOfClass:[NSNull class]]||[[dic objectForKey:@"item_name"]isEqualToString:@"糖尿病"]||[[dic objectForKey:@"iteme_value"] isKindOfClass:[NSNull class]]) {

                tnb = [dic objectForKey:@"iteme_value"];
            } else if ([[dic objectForKey:@"item_name"] isKindOfClass:[NSNull class]]||[[dic objectForKey:@"item_name"]isEqualToString:@"冠心病"]||[[dic objectForKey:@"iteme_value"] isKindOfClass:[NSNull class]]){
                gxb = [dic objectForKey:@"item_value"];
            } else if ([[dic objectForKey:@"item_name"] isKindOfClass:[NSNull class]]||[[dic objectForKey:@"item_name"]isEqualToString:@"高血压"]||[[dic objectForKey:@"iteme_value"] isKindOfClass:[NSNull class]]){
                gxy = [dic objectForKey:@"item_value"];
            } else if ([[dic objectForKey:@"item_name"] isKindOfClass:[NSNull class]]||[[dic objectForKey:@"item_name"]isEqualToString:@"高血脂"]|[[dic objectForKey:@"iteme_value"] isKindOfClass:[NSNull class]]){
                gxz = [dic objectForKey:@"item_value"];
            } else if([[dic objectForKey:@"item_name"] isKindOfClass:[NSNull class]]||[[dic objectForKey:@"iteme_value"] isKindOfClass:[NSNull class]]){
                nxg = [dic objectForKey:@"item_value"];
            }
        }
        
    }
    
    [_tableArray addObject:@{@"image":@"",@"key":@"家族",@"value":@""}];//9
    if (tnb) {
        
        [_tableArray addObject:@{@"image":@"",@"key":@"糖尿病",@"value":tnb}];//10
    } else{
        [_tableArray addObject:@{@"image":@"",@"key":@"糖尿病",@"value":@""}];//10
    }
    if (gxb) {
        
        [_tableArray addObject:@{@"image":@"",@"key":@"冠心病",@"value":gxb}];//11
    }else{
        [_tableArray addObject:@{@"image":@"",@"key":@"冠心病",@"value":@""}];//11
    }
    if (gxy) {
        
        [_tableArray addObject:@{@"image":@"",@"key":@"高血压",@"value":gxy}];//12
    } else{
        [_tableArray addObject:@{@"image":@"",@"key":@"高血压",@"value":@""}];//12
    }
    if (gxz) {
        
        [_tableArray addObject:@{@"image":@"",@"key":@"高血脂",@"value":gxz}];//13
    }else{
        [_tableArray addObject:@{@"image":@"",@"key":@"高血脂",@"value":@""}];//13
    }
    if (nxg) {
        
        [_tableArray addObject:@{@"image":@"",@"key":@"脑血管意外",@"value":nxg}];//14
    }else{
        [_tableArray addObject:@{@"image":@"",@"key":@"脑血管意外",@"value":@""}];//14
    }
    
    self.tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT) style:UITableViewStyleGrouped];
    self.tableView.rowHeight = 60;
    self.tableView.delegate = self;
    self.tableView.dataSource = self;
    
    [self.view addSubview:self.tableView];
    
    self.tableView.contentInset = UIEdgeInsetsMake(0, 0, 40, 0);
    self.tableView.tableFooterView.userInteractionEnabled = YES;
    footerView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 60)];
    //    footerView.backgroundColor = [UIColor blackColor];
    //    self.tableView.tableFooterView.backgroundColor = [UIColor grayColor];
    UIButton * saveBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    saveBtn.frame = CGRectMake(10, 10, 300, 40);
    [saveBtn setTitle:@"保存" forState:UIControlStateNormal];
    saveBtn.backgroundColor = [UIColor blueColor];
    [saveBtn addTarget:self action:@selector(saveAction:) forControlEvents:UIControlEventTouchUpInside];
    [footerView addSubview:saveBtn];
    footerView.userInteractionEnabled = YES;
    //    [self.tableView.tableFooterView addSubview:footerView];
    self.locatePicker = [[HZAreaPickerView alloc] initWithStyle:HZAreaPickerWithStateAndCityAndDistrict delegate:self];

    [self.tableView reloadData];
}
#pragma mark - saveAction
- (void)saveAction:(id)sender{
    
    [self saveRequest];
}
#pragma mark - request
- (void)saveRequest{
    AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
    manager.responseSerializer.acceptableContentTypes = [NSSet setWithObject:@"text/html"];
    
    if ([[_tableArray[1]objectForKey:@"value"]isEqualToString:@"男"]) {
        sexStr = @"1";
    } else if ([[_tableArray[1]objectForKey:@"value"]isEqualToString:@"女"]){
        sexStr= @"2";
    }else{
        sexStr = @"0";
    }
    NSArray * arr = @[@{@"item_name":@"糖尿病",@"item_value":[_tableArray[10] objectForKey:@"value"]},@{@"item_name":@"冠心病",@"item_value":[_tableArray[11] objectForKey:@"value"]},@{@"item_name":@"高血压",@"item_value":[_tableArray[12] objectForKey:@"value"]},@{@"item_name":@"高血脂",@"item_value":[_tableArray[13] objectForKey:@"value"]},@{@"item_name":@"脑血管意外",@"item_value":[_tableArray[14] objectForKey:@"value"]}];
    //        NSMutableData * tempJsonData = [NSMutableData dataWithData:jsonData];
    
    NSData * jsonData = [NSJSONSerialization dataWithJSONObject:arr options:NSJSONWritingPrettyPrinted error:
                         nil];
    NSString *jsonString = [[NSString alloc] initWithData:jsonData encoding:NSUTF8StringEncoding];

    NSDictionary *dic = [NSDictionary dictionaryWithObjectsAndKeys:[_tableArray[0] objectForKey:@"value"],@"realname",sexStr,@"gender",[_tableArray[2] objectForKey:@"value"],@"height",[_tableArray[3] objectForKey:@"value"],@"weight",[_tableArray[4] objectForKey:@"value"],@"idcard",[_tableArray[5] objectForKey:@"value"],@"field2",[_tableArray[6] objectForKey:@"value"],@"field1",[_tableArray[7] objectForKey:@"value"],@"resideprovince",jsonString,@"family_history", nil];
    
 

    [manager POST:@"http://test.tanghushi.com/api/mobile/?version=2&module=userinfo&op=edit" parameters:dic success:^(AFHTTPRequestOperation *operation, id responseObject) {
        id value = [[responseObject objectForKey:@"Variables"] objectForKey:@"value"];
        NSNumberFormatter* numberFormatter = [[NSNumberFormatter alloc] init];
        NSString * str = [numberFormatter stringFromNumber:value];
        
        
        if ([str isEqualToString:@"1"]) {
//            [FVCustomAlertView showDefaultDoneAlertOnView:self.view withTitle:@"恭喜您，修改成功!"];
            DXAlertView * alert = [[DXAlertView alloc] initWithTitle:@"提示" contentText:@"修改成功" leftButtonTitle:nil rightButtonTitle:@"确定"];
            [alert show];
            alert.rightBlock = ^(){
                [self.navigationController popViewControllerAnimated:YES];
            };
        }else{
            [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"修改失败"];
        }
        [_tableView reloadData];
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        NSLog(@"修改失败");
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"修改失败"];
    }];
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    [self.tableView.tableFooterView setFrame:CGRectMake(0, self.tableView.frame.size.height, SCREEN_WIDTH, 60)];
    if (section==3) {
        return footerView;
    }
    return nil;
    
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    if (section==3) {
        return 60;
    }
    else {
        return 10;
    }
}

-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    if (section==0) {
        return 10;
    } else{
        return 20;
    }
}
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return  4;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section==0) {
        return 5;
    }else if (section==1){
        return 3;
    } else if (section==2){
        return 1;
    }else{
        return 6;
    }
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    static NSString * ce = @"aa";
    UITableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:ce];
    if (!cell) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:ce];
        cell.detailTextLabel.textColor = [UIColor blueColor];
    }
    
    cell.accessoryType = UITableViewCellAccessoryDisclosureIndicator;
    if (indexPath.section==0) {

        cell.textLabel.text = [[_tableArray objectAtIndex:indexPath.row] objectForKey:@"key"];
        cell.detailTextLabel.text = [[_tableArray objectAtIndex:indexPath.row] objectForKey:@"value"];
        
    } else if (indexPath.section==1){
        cell.textLabel.text = [[_tableArray objectAtIndex:indexPath.row+5] objectForKey:@"key"];
        cell.detailTextLabel.text = [[_tableArray objectAtIndex:indexPath.row+5]objectForKey:@"value"];
        
    } else if (indexPath.section == 2){
        cell.textLabel.text =[[_tableArray objectAtIndex:indexPath.row+8] objectForKey:@"key"];
    }else if(indexPath.section==3){
//        if (indexPath.row==1) {
        cell.textLabel.text=[[_tableArray objectAtIndex:indexPath.row+9] objectForKey:@"key"];
        cell.detailTextLabel.text = [[_tableArray objectAtIndex:indexPath.row+9]objectForKey:@"value"];
//        }
//        NSLog(@"tablearray===%@",_tableArray);
        if (indexPath.row==0) {
            cell.accessoryType = UITableViewCellAccessoryNone;
            cell.selectionStyle = UITableViewCellSelectionStyleNone;
        }
    }
    return cell;
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    JSPickerView * Picker = [JSPickerView pickerViewInstance];
    UIStoryboard * secondSB = [UIStoryboard storyboardWithName:@"Mine" bundle:nil];
    SecondViewController * secondVC = (SecondViewController *)[secondSB instantiateViewControllerWithIdentifier:@"second"];
    if (indexPath.section==0) {
        if (indexPath.row==0||indexPath.row==4) {
            
            secondVC.string = [[_tableArray objectAtIndex:indexPath.row] objectForKey:@"value"];
            [self.navigationController pushViewController:secondVC animated:YES];
            [secondVC valueOfBlock:^(NSString *string) {
                UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                cell.detailTextLabel.text = string;
                if (indexPath.section==0) {
                    if (indexPath.row==0) {
                        NSString *name = cell.detailTextLabel.text;
                        [_tableArray replaceObjectAtIndex:indexPath.row withObject:@{@"image":@"",@"key":@"姓名",@"value":name}];
                    }else if (indexPath.row ==4){
                        NSString * idCard = cell.detailTextLabel.text;
                        [_tableArray replaceObjectAtIndex:indexPath.row withObject:@{@"image":@"",@"key":@"身份证号码",@"value":idCard}];
                    }
                }
            }];
        } else if (indexPath.row==1){
            NSArray * array = @[@"男",@"女"];
            Picker.firstMArr = (NSMutableArray *)array;
            [Picker showInView:self.view];
            [Picker valueOfCurrentStr:^(NSString *currentStr) {
                UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                cell.detailTextLabel.text = currentStr;
                [_tableArray replaceObjectAtIndex:indexPath.row withObject:@{@"image":@"",@"key":@"性别",@"value":currentStr}];
            }];
        } else if (indexPath.row==2){
            NSMutableArray * array = [[NSMutableArray alloc]init];
            for (int i = 50; i<220; i++) {
                [array addObject:[NSString stringWithFormat:@"%d cm",i]];
            }
            Picker.firstMArr = array;
            [Picker showInView:self.view];
            [Picker valueOfCurrentStr:^(NSString *currentStr) {
                UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                cell.detailTextLabel.text = currentStr;
                [_tableArray replaceObjectAtIndex:indexPath.row withObject:@{@"image":@"",@"key":@"身高",@"value":currentStr}];
            }];
        } else if (indexPath.row==3){
            NSMutableArray * array = [[NSMutableArray alloc] init];
            for (int i = 40; i<150; i++) {
                [array addObject:[NSString stringWithFormat:@"%d kg",i]];
            }
            Picker.firstMArr = array;
            [Picker showInView:self.view];
            [Picker valueOfCurrentStr:^(NSString *currentStr) {
                UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                cell.detailTextLabel.text = currentStr;
                [_tableArray replaceObjectAtIndex:indexPath.row withObject:@{@"image":@"",@"key":@"体重",@"value":currentStr}];
            }];
        }
    }else if (indexPath.section==1){
        if (indexPath.row==0) {
            NSMutableArray * array = [[NSMutableArray alloc] init];
            for (int i = 1990; i<2014; i++) {
                [array addObject:[NSString stringWithFormat:@"%d ",i]];
            }
            Picker.firstMArr = array;
            [Picker showInView:self.view];
            [Picker valueOfCurrentStr:^(NSString *currentStr) {
                UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                cell.detailTextLabel.text = currentStr;
                [_tableArray replaceObjectAtIndex:5 withObject:@{@"image":@"",@"key":@"确诊时间",@"value":currentStr}];
               
            }];
        } else if (indexPath.row==1){
            NSArray * arr = @[@"1型",@"2型",@"LADA"];
            Picker.firstMArr = (NSMutableArray *)arr;
            [Picker showInView:self.view];
            [Picker valueOfCurrentStr:^(NSString *currentStr) {
                UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                cell.detailTextLabel.text = currentStr;
                [_tableArray replaceObjectAtIndex:6 withObject:@{@"image":@"",@"key":@"确诊类型",@"value":currentStr}];
            }];
        }else if (indexPath.row==2){
            [self.locatePicker showInView:self.view];
            [self.locatePicker valueOfCurrentStr:^(NSString *currentStr) {
                UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                cell.detailTextLabel.text = currentStr;
                [_tableArray replaceObjectAtIndex:7 withObject:@{@"image":@"",@"key":@"所在地",@"value":currentStr}];
            }];
        }
        
    }
    else if (indexPath.section == 2){
        
        UIStoryboard *medicalRecord = [UIStoryboard storyboardWithName:@"MedicalRecord" bundle:nil];
        MedicalRecordListViewController *medicalRecordListController = [medicalRecord instantiateViewControllerWithIdentifier:@"medicalRecordList"];
        [self.navigationController pushViewController:medicalRecordListController animated:YES];
        
    }
    else if (indexPath.section==3){
        
        
        if (indexPath.row==1 || indexPath.row==2 || indexPath.row==3 || indexPath.row==4 || indexPath.row==5) {
            FamilyController * familyVC = [[FamilyController alloc] init];
            [self.navigationController pushViewController:familyVC animated:YES];
          [familyVC valueOfFamily:^(NSMutableArray *array) {
              NSString *str = [[NSString alloc] init];
              str = [array componentsJoinedByString:@"、"];
              NSLog(@"array-=-=-=-=-=-=-==-%@",str);
              if (indexPath.row==1) {
                  [_tableArray replaceObjectAtIndex:10 withObject:@{@"image":@"",@"key":@"糖尿病",@"value":str}];
                  UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                   cell.detailTextLabel.text = [_tableArray[10] objectForKey:@"value"];
                   [cell.detailTextLabel setFont:[UIFont fontWithName:nil size:12]];
              }else if (indexPath.row==2){
                   [_tableArray replaceObjectAtIndex:11 withObject:@{@"image":@"",@"key":@"冠心病",@"value":str}];
                  UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                  cell.detailTextLabel.text = [_tableArray[11] objectForKey:@"value"];
                   [cell.detailTextLabel setFont:[UIFont fontWithName:nil size:12]];
              }else if (indexPath.row==3){
                   [_tableArray replaceObjectAtIndex:12 withObject:@{@"image":@"",@"key":@"高血压",@"value":str}];
                  UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                  cell.detailTextLabel.text = str;
                   [cell.detailTextLabel setFont:[UIFont fontWithName:nil size:12]];
              }else if (indexPath.row==4){
                   [_tableArray replaceObjectAtIndex:13 withObject:@{@"image":@"",@"key":@"高血脂",@"value":str}];
                  UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                  cell.detailTextLabel.text = str;
                   [cell.detailTextLabel setFont:[UIFont fontWithName:nil size:12]];
              }else if (indexPath.row==5){
                   [_tableArray replaceObjectAtIndex:14 withObject:@{@"image":@"",@"key":@"脑血管意外",@"value":str}];
                  UITableViewCell * cell = [_tableView cellForRowAtIndexPath:indexPath];
                  cell.detailTextLabel.text = str;
                   [cell.detailTextLabel setFont:[UIFont fontWithName:nil size:12]];
              }
              NSLog(@"tablearray===%@",_tableArray);
//              [_tableView reloadData];
              
          }];
        }
    }

}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
