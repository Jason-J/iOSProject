//
//  OtherRemindViewController.m
//  TangNiaoBingHuShi
//
//  Created by Jason on 14-11-21.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "OtherRemindViewController.h"
#import "AlarmClock.h"
#import "JSDatePickerView.h"
#import "MyDatePickerView.h"
@interface OtherRemindViewController ()<UITextViewDelegate, UIActionSheetDelegate>
@property (weak, nonatomic) IBOutlet UIButton *remindTimeBtn;
@property (weak, nonatomic) IBOutlet UILabel *placeholderLabel;
@property (weak, nonatomic) IBOutlet UILabel *remindTimeLabel;
@property (weak, nonatomic) IBOutlet UITextView *textView;
@property (nonatomic, strong) NSMutableArray *alarmClockMArr;
@property (nonatomic, strong) NSDate *date;
@end

@implementation OtherRemindViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    _textView.delegate = self;
    [self readAlarmFromLocal];
}
#pragma  mark- 闹钟本地逻辑
-(void)readAlarmFromLocal
{
    NSString *docPath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];
    NSString *familyArrPath = [docPath stringByAppendingPathComponent:@"alarmClock.aa"];
    NSArray *array = [NSKeyedUnarchiver unarchiveObjectWithFile:familyArrPath];
    if (array) {
        
        _alarmClockMArr = [NSKeyedUnarchiver unarchiveObjectWithFile:familyArrPath];
    } else {
        _alarmClockMArr = [[NSMutableArray alloc] init];
    }
}
#pragma  mark- 警告框消失方法
-(void)hiddenAlertView
{
    [NSTimer scheduledTimerWithTimeInterval:2 target:self selector:@selector(hiddenAlertViewNow) userInfo:nil repeats:1];
}
-(void)hiddenAlertViewNow
{
    [FVCustomAlertView hideAlertFromView:self.view fading:YES];
}
#pragma  mark- 保存闹钟方法
- (IBAction)saveAlarmClockBtnAction:(id)sender {
    
   
    if ([_remindTimeLabel.text isEqualToString:@""]) {
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"请填写提醒时间"];
        [self hiddenAlertView];
    } else if ([_textView.text isEqualToString:@""]) {
        [FVCustomAlertView showDefaultErrorAlertOnView:self.view withTitle:@"请填写备注内容"];
    } else {
        AlarmClock *alarmClock = [[AlarmClock alloc] init];
        alarmClock.remarks = _textView.text;
        alarmClock.time = _remindTimeLabel.text;
        [_alarmClockMArr addObject:alarmClock];
        [self physicalRemindAction:alarmClock date:_date];
        [self writeToLocal];
        
        
        [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:([self.navigationController.viewControllers count] - 3)] animated:YES];
    }
}

#pragma  mark- 其他提醒闹钟方法
-(void)remindAction:(AlarmClock *)alarm
{
    
}
//闹钟写入本地
- (void)writeToLocal
{
    NSString *docPath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];
    NSString *familyArrPath = [docPath stringByAppendingPathComponent:@"alarmClock.aa"];
    NSLog(@"%@", familyArrPath);
    [NSKeyedArchiver archiveRootObject:_alarmClockMArr toFile:familyArrPath];
    NSArray *array = [NSKeyedUnarchiver unarchiveObjectWithFile:familyArrPath];
    NSLog(@"%@", array);
}
#pragma  mark- 开始编辑方法
-(void)textViewDidBeginEditing:(UITextView *)textView
{
    _placeholderLabel.hidden = YES;
}
#pragma  mark- 结束编辑方法
-(BOOL)textViewShouldEndEditing:(UITextView *)textView
{
    if (_textView.text.length ==0) {
        _placeholderLabel.hidden = NO;
        
    }
    return YES;
}
#pragma  mark- 回收键盘 
-(void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event
{
    [_textView resignFirstResponder];
    
}
#pragma  mark- 检查提醒闹钟实现
- (void)physicalRemindAction:(AlarmClock *) alarmClock date:(NSDate *)date
{
    
    UILocalNotification *localNotification = [[UILocalNotification alloc] init];
    if (localNotification) {
        NSDate *nowDate = [NSDate date];
        
        localNotification.fireDate = [nowDate dateByAddingTimeInterval:[date timeIntervalSinceNow]];
        localNotification.alertBody = alarmClock.remarks;
        localNotification.soundName = UILocalNotificationDefaultSoundName;
        localNotification.timeZone = [NSTimeZone defaultTimeZone];
        localNotification.alertAction = @"查看闹钟";
        localNotification.repeatInterval = 0;
        NSDictionary *userInfo = [NSDictionary dictionaryWithObject:[NSString stringWithFormat:@"%@",alarmClock.remarks] forKey:@"alarmClock3"];
        localNotification.userInfo = userInfo;
        localNotification.applicationIconBadgeNumber = 1;
        [[UIApplication sharedApplication] scheduleLocalNotification:localNotification];
    }
}
#pragma  mark- 备注被修改方法
-(void)textViewDidChange:(UITextView *)textView
{
    if (_textView.text.length ==0) {
        _placeholderLabel.hidden = NO;
        
    }
}


- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}
#pragma  mark- 提醒时间按钮方法
- (IBAction)remindTimeBtn:(id)sender {
    if (IOS_VERSION >= 8.0) {
        JSDatePickerView *picker = [JSDatePickerView datePickerViewInstance];
        picker.datePicker.datePickerMode = UIDatePickerModeDateAndTime;
        [picker valueOfDate:^(NSDate *date, NSString *currentStr) {
            NSDateFormatter *fom = [[NSDateFormatter alloc] init];
            [fom setDateFormat:@"YYYY-MM-dd HH:mm"];
            _remindTimeLabel.text = [fom stringFromDate:date];
        }];
        [picker showInView:self.view];
    } else {
        MyDatePickerView *myDatePickerView = [[MyDatePickerView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT / 2)];
        UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:@"\n\n\n\n" delegate:self cancelButtonTitle:@"" destructiveButtonTitle:@"" otherButtonTitles:nil, nil];
        [actionSheet addSubview:myDatePickerView];
        [actionSheet showInView:self.view];
        [myDatePickerView valueOfHiddenBlock:^{
            [actionSheet dismissWithClickedButtonIndex:1 animated:YES];
        }];
        myDatePickerView.datePicker.datePickerMode = UIDatePickerModeDateAndTime;
        [myDatePickerView valueOfDatePicker:^(UIDatePicker *datePicker) {
            _date = datePicker.date;
        }];
        
        [myDatePickerView valueOfBlock:^(NSString *dateStr) {
            [_remindTimeLabel setText:dateStr];
        }];
        
    }
    

    
}
-(UIDatePicker *)remindDate:(UIDatePicker *)datePicker
{
    return datePicker;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
