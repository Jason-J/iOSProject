//
//  SportsRemindViewController.m
//  TangNiaoBingHuShi
//
//  Created by Jason on 14-11-20.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "SportsRemindViewController.h"
#import "RepeatAlarmClockViewController.h"
#import "MyDatePickerView.h"
#import "AFNetworking.h"
#import "JSDatePickerView.h"
@interface SportsRemindViewController ()<UIActionSheetDelegate, UITextViewDelegate, UIAlertViewDelegate>
@property (weak, nonatomic) IBOutlet UIScrollView *scrollView;
@property (weak, nonatomic) IBOutlet UIButton *remindTimeBtn;
@property (nonatomic, strong) NSMutableArray *alarmClockMArr;
@property (nonatomic, strong) MyDatePickerView *myDatePickerView;
@property (weak, nonatomic) IBOutlet UIButton *sportsTimeBtn;
@property (weak, nonatomic) IBOutlet UILabel *sportsTimeLabel;
@property (weak, nonatomic) IBOutlet UILabel *sportsIntensityLabel;
@property (weak, nonatomic) IBOutlet UIButton *sportsIntensityBtn;
@property (nonatomic, strong) NSArray *sportsTimeArr;
@property (nonatomic, strong) NSArray *sportsIntensityArr;

@property (weak, nonatomic) IBOutlet UILabel *placeholderLabel;

@property (weak, nonatomic) IBOutlet UIButton *repeatBtn;
@property (weak, nonatomic) IBOutlet UITextView *textView;
@property (weak, nonatomic) IBOutlet UILabel *remindTimeLabel;
@property (weak, nonatomic) IBOutlet UILabel *repeatLabel;
@property (nonatomic, copy) NSMutableString *repeatString;
@property (weak, nonatomic) IBOutlet UILabel *sportLabel;
@property (nonatomic, strong) NSMutableArray *sportsMArr;
@end


@implementation SportsRemindViewController
-(void)viewDidLayoutSubviews
{
    [super viewDidLayoutSubviews];
       _scrollView.contentSize = CGSizeMake(self.view.self.frame.size.width, 800);
}
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    _sportsTimeArr = @[@"10分钟", @"15分钟", @"25分钟", @"35分钟", @"45分钟", @"1小时"];
    _sportsIntensityArr = @[@"强", @"中", @"弱"];
    _sportsMArr = [[NSMutableArray alloc] initWithObjects:@"其他运动", nil];
    _repeatString  = [[NSMutableString alloc] init];
    _alarmClock = [[AlarmClock alloc] init];
    _textView.delegate = self;
    [self setAutomaticallyAdjustsScrollViewInsets:NO];
    _scrollView.frame = CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height);
 
    
    _myDatePickerView = [[MyDatePickerView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT / 2)];
//    [self.view addSubview:_myDatePickerView];

    _myDatePickerView.datePicker.datePickerMode = UIDatePickerModeTime;
    _myDatePickerView.datePicker.timeZone = [NSTimeZone localTimeZone];

}
#pragma  mark- 保存闹钟方法
- (IBAction)saveBtnAction:(id)sender {
    if ([_remindTimeLabel.text isEqualToString:@""]) {
        [FVCustomAlertView showDefaultWarningAlertOnView:self.view withTitle:@"请选择提醒时间"];
        [self hiddenAlertView];
    }  else if ([_sportsTimeLabel.text isEqualToString:@""]) {
        [FVCustomAlertView showDefaultWarningAlertOnView:self.view withTitle:@"请选择运动时间"];
        [self hiddenAlertView];
        
    } else if ([_sportsIntensityLabel.text isEqualToString:@""]) {
        [FVCustomAlertView showDefaultWarningAlertOnView:self.view withTitle:@"请选择运动强度"];
        [self hiddenAlertView];
     
    } else if ([_sportLabel.text isEqualToString:@""])     {
        [FVCustomAlertView showDefaultWarningAlertOnView:self.view withTitle:@"请选择运动项目"];
        [self hiddenAlertView];
    }else if ([_repeatLabel.text isEqualToString:@""]) {
        [FVCustomAlertView showDefaultWarningAlertOnView:self.view withTitle:@"请选择重复周期"];
        [self hiddenAlertView];
       
    } else {
        
        _alarmClock.time = _remindTimeLabel.text;
        _alarmClock.checkProject = _sportLabel.text;
        _alarmClock.repeat = _repeatLabel.text;
        _alarmClock.alarmType = @"2";
        NSLog(@"-------::%@", _alarmClock.Monday);
        [self readAlarmFromLocal];
        [_alarmClockMArr addObject:_alarmClock];
        [self writeToLocal];
         [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:([self.navigationController.viewControllers count] - 3)] animated:YES];
    }

}
#pragma  mark- 本地读取闹钟
-(void)readAlarmFromLocal
{
    NSString *docPath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];
    NSString *familyArrPath = [docPath stringByAppendingPathComponent:@"alarmClock.aa"];
    NSArray *array = [NSKeyedUnarchiver unarchiveObjectWithFile:familyArrPath];
    if (array) {
        
        _alarmClockMArr = [NSKeyedUnarchiver unarchiveObjectWithFile:familyArrPath];
    } else {
        _alarmClockMArr = [[NSMutableArray alloc] init];
    }
}
#pragma  mark- 闹钟本地存储
- (void)writeToLocal
{
    NSString *docPath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];
    NSString *familyArrPath = [docPath stringByAppendingPathComponent:@"alarmClock.aa"];
    NSLog(@"%@", familyArrPath);
    [NSKeyedArchiver archiveRootObject:_alarmClockMArr toFile:familyArrPath];
    NSArray *array = [NSKeyedUnarchiver unarchiveObjectWithFile:familyArrPath];
    NSLog(@"%@", array);
}
#pragma  mark- 警告框消失方法
-(void)hiddenAlertView
{
    [NSTimer scheduledTimerWithTimeInterval:2 target:self selector:@selector(hiddenAlertViewNow) userInfo:nil repeats:1];
}
-(void)hiddenAlertViewNow
{
    [FVCustomAlertView hideAlertFromView:self.view fading:YES];
}
#pragma  mark- 选择重复周期
- (IBAction)repeatBtnAction:(id)sender {
    RepeatAlarmClockViewController *repeatAlarmClockVC = [[RepeatAlarmClockViewController alloc] init];
    repeatAlarmClockVC.alarmClock = _alarmClock;
    [repeatAlarmClockVC valueOfReturnBLOCK:^(AlarmClock *alarmClock) {
        _alarmClock = alarmClock;
        
        [_repeatString setString:@""];
        NSLog(@"zhou  ------- %@", _alarmClock.Monday);
        if ([_alarmClock.Monday isEqualToString:@"1"]) {
            [_repeatString appendString:@"周一"];
        }
        if ([_alarmClock.Tuesday isEqualToString:@"1"]){
            [_repeatString appendString:@" 周二"];
        }
        if ([_alarmClock.Wednesday isEqualToString:@"1"]){
            [_repeatString appendString:@" 周三"];
        }
        if ([_alarmClock.Thursday isEqualToString:@"1"]){
            [_repeatString appendString:@" 周四"];
        }
        if ([_alarmClock.Friday isEqualToString:@"1"]){
            [_repeatString appendString:@" 周五"];
        }
        if ([_alarmClock.Saturday isEqualToString:@"1"]){
            [_repeatString appendString:@" 周六"];
        }
        if ([_alarmClock.Sunday isEqualToString:@"1"]){
            [_repeatString appendString:@" 周日"];
        }
        [_repeatLabel setText:_repeatString];
    }];
    [self.navigationController pushViewController:repeatAlarmClockVC animated:YES];
    
}
#pragma  mark- 自定义输入运动名
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (buttonIndex == 1) {
        _sportLabel.text = [[alertView textFieldAtIndex:0] text];
    }
}
#pragma  mark- 修改textView内容
-(void)textViewDidBeginEditing:(UITextView *)textView
{
    _placeholderLabel.hidden = YES;
}
#pragma  mark- 提醒时间按钮
- (IBAction)remindTimeBtnAction:(id)sender {
    if (IOS_VERSION >=8.0) {
        JSDatePickerView *picker = [JSDatePickerView datePickerViewInstance];
        picker.datePicker.datePickerMode = UIDatePickerModeTime;
       
  
        [picker showInView:self.view];
        [picker valueOfDate:^(NSDate *date, NSString *currentStr) {
            NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
            
            [formatter setDateFormat:@"HH:mm"];
               NSString *dateStr = [formatter stringFromDate:date];
            _remindTimeLabel.text = dateStr;
            
        }];
        
    } else {
        
        UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:@"\n\n\n\n" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:@"ss" otherButtonTitles:nil, nil];
        [actionSheet addSubview:_myDatePickerView];
        [actionSheet showInView:self.view];
        NSLog(@"%@", _myDatePickerView.datePicker.date);
        [_myDatePickerView valueOfBlock:^(NSString *dateStr) {
            //        _remindTimeLabel.text = dateStr;
        }];
        //
        [_myDatePickerView valueOfHiddenBlock:^{
            [actionSheet dismissWithClickedButtonIndex:1 animated:YES];
        }];
        
        [_myDatePickerView  valueOfDatePicker:^(UIDatePicker *datePicker) {
            NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
            
            [formatter setDateFormat:@"HH:mm"];
            NSString *dateStr = [formatter stringFromDate:datePicker.date];
            _remindTimeLabel.text = dateStr;
        }];
    }
}
#pragma  mark- 运动强度选择
- (IBAction)sportsIntensityBtnAction:(id)sender {
//    UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:@"请选择运动强度" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:nil otherButtonTitles:@"强", @"中", @"弱", nil];
//    actionSheet.tag = 22222;
//    [actionSheet showInView:self.view];
    JSPickerView *picker = [JSPickerView pickerViewInstance];
    picker.firstMArr = (NSMutableArray *)_sportsIntensityArr;
    [picker valueOfCurrentStr:^(NSString *currentStr) {
        _sportsIntensityLabel.text = currentStr;
        [self getProjectsFromServerWithSport:currentStr];
    }];
    [picker showInView:self.view];
}
#pragma  mark- 回收键盘
-(void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event
{
    [super touchesBegan:touches withEvent:event];
    [_textView resignFirstResponder];
}
#pragma  mark- 推荐项目按钮点击
- (IBAction)sportNameBtnAction:(id)sender {
//    UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:@"请选择您想做的运动" delegate:self cancelButtonTitle:nil destructiveButtonTitle:@"推荐的都不喜欢" otherButtonTitles:nil, nil];
//    for (int i = 0; i < _sportsMArr.count -1; i ++) {
//        [actionSheet addButtonWithTitle:[_sportsMArr objectAtIndex:i + 1]];
//    }
////    actionSheet.actionSheetStyle = UIActionSheetStyleBlackOpaque;
//    [actionSheet addButtonWithTitle:@"取消"];
//    NSLog(@"%ld", (long)actionSheet.cancelButtonIndex);
//    actionSheet.tag = 33333;
//    actionSheet.cancelButtonIndex = actionSheet.numberOfButtons - 1;
//    
//    [actionSheet showInView:self.view];
    JSPickerView *picker = [JSPickerView pickerViewInstance];
    picker.firstMArr = _sportsMArr;
    [picker valueOfCurrentStr:^(NSString *currentStr) {
        if ([currentStr isEqualToString:@"其他运动"]) {
            UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:@"糖尿病护士提醒" message:@"请输入您想做的运动" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确认", nil];
            alertView.alertViewStyle = UIAlertViewStylePlainTextInput;
            [alertView show];
        } else {
            _sportLabel.text = currentStr;
        }
    }];
    [picker showInView:self.view];
}
#pragma  mark- 运动时间按钮
- (IBAction)sportsTimeBtnAction:(id)sender {
//    UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:@"请选择您要运动的时间" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:nil otherButtonTitles:@"10分钟", @"15分钟", @"25分钟", @"35分钟", @"45分钟", @"1小时", nil];
//    actionSheet.tag = 11111;
//    [actionSheet showInView:self.view];
    JSPickerView *picker = [JSPickerView pickerViewInstance];
    picker.firstMArr = (NSMutableArray *)_sportsTimeArr;
    [picker valueOfCurrentStr:^(NSString *currentStr) {
        _sportsTimeLabel.text = currentStr;
    }];
    [picker showInView:self.view];
}
#pragma  mark- UIActionSheet Delegate
-(void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    #pragma  mark- 运动时间选择结果
    if (actionSheet.tag == 11111) {
        if (buttonIndex == 6) {
            return;
        }
        _sportsTimeLabel.text = [_sportsTimeArr objectAtIndex:buttonIndex];
    } else if (actionSheet.tag == 22222){
        if (buttonIndex == 3) {
            return;
        }
        
        [_sportsIntensityLabel setText:[_sportsIntensityArr objectAtIndex:buttonIndex]];
        [self getProjectsFromServerWithSport:_sportsIntensityLabel.text];
    } else
    {
        NSLog(@"%ld", (long)buttonIndex);
        if (buttonIndex == 0) {
            UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:@"糖尿病护士提醒" message:@"请输入您想做的运动" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确认", nil];
            alertView.alertViewStyle = UIAlertViewStylePlainTextInput;
            [alertView show];
            return;
        } else if (buttonIndex == actionSheet.numberOfButtons - 1) {
            return;
            
        }
        _sportLabel.text = [_sportsMArr objectAtIndex:buttonIndex];
    }
}
#pragma  mark- 从服务器获取推荐项目
-(void)getProjectsFromServerWithSport:(NSString *)sport
{
    [FVCustomAlertView showDefaultLoadingAlertOnView:self.view withTitle:@"努力加载中"];
    NSString *urlStr = [[NSString stringWithFormat:@"http://test.tanghushi.com/api/mobile/?version=2&module=clock&op=getrecommend&strength=%@", sport]stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
    NSURL *url = [NSURL URLWithString:urlStr];
    NSURLRequest *request = [NSURLRequest requestWithURL:url cachePolicy:NSURLRequestReloadIgnoringLocalCacheData timeoutInterval:20];
    AFHTTPRequestOperation *operation = [[AFHTTPRequestOperation alloc] initWithRequest:request];
    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
        id object = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableLeaves error:nil];
        NSLog(@"%@", object);
        [_sportsMArr removeAllObjects];
        [_sportsMArr addObject:@"其他运动"];
        [_sportsMArr addObjectsFromArray: [[object objectForKey:@"Variables"] objectForKey:@"value"]];
        NSLog(@"sports%@", _sportsMArr);
        [self hiddenAlertViewNow];
       
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        
    }];
    [operation start];

}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
