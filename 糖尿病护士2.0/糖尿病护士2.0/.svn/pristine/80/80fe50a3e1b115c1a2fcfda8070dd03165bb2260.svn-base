//
//  ChatView.m
//  TangNiaoBingHuShi
//
//  Created by Jason on 14-12-11.
//  Copyright (c) 2014年 Jason. All rights reserved.
//

#import "ChatView.h"
#import "KGModal.h"
@implementation ChatView

- (void)awakeFromNib {
    // Initialization code
    _isVoice = YES;
    _pressSendBtn.hidden = YES;
    _textView.delegate = self;
    

}
- (IBAction)releaseBtnAction:(UIButton *)sender {
    NSLog(@"松开");
    [_view removeFromSuperview];
//    [self.delegate endSaveVoice];
}
- (IBAction)pressBtnAction:(id)sender {
    NSLog(@"按下");
//    [self.delegate startSaveVoice];
    _view = [[UIView alloc] initWithFrame:CGRectMake(106, -250, 107, 107)];
    UIImageView *voiceImageView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0, 107, 107)];
    voiceImageView.animationDuration = 1;
    voiceImageView.animationImages = [self setUpImage];
    [voiceImageView startAnimating];
    [_view addSubview:voiceImageView];
    [self addSubview:_view];
    
}
- (NSArray *)setUpImage
{
    NSMutableArray *array = [[NSMutableArray alloc] init];
    for (int i = 3; i  >= 1; i--) {
        [array addObject:[UIImage imageNamed:[NSString stringWithFormat:@"yuyin_0%d",i]]];
    }
    return array;
}
- (IBAction)voiceBtnAction:(UIButton *)sender {
    
    if (_isVoice) {
        _isVoice = NO;
        _pressSendBtn.hidden = NO;
        _textView.hidden = YES;
        [sender setImage:[UIImage imageNamed:@"exchange_keyboard.png"] forState:UIControlStateNormal];
        
    }else {
        _pressSendBtn.hidden = YES;
        _textView.hidden = NO;
        _isVoice = YES;
        [sender setImage:[UIImage imageNamed:@"exchange_voice.png"] forState:UIControlStateNormal];
    }
}
-(void)textViewDidBeginEditing:(UITextView *)textView
{
    [self registerForKeyboardNotifications];
    if ([_delegate respondsToSelector:@selector(showKeyboardWithKeyboardSize:)]) {
        [self.delegate showKeyboardWithKeyboardSize:_keyboardSize];
    }
    [self showInView:self];
}
-(BOOL)textView:(UITextView *)textView shouldChangeTextInRange:(NSRange)range replacementText:(NSString *)text
{
    if ([text isEqualToString:@"\n"]) {
        [self.delegate sendMessageWith:_textView.text];
        [_textView resignFirstResponder];
        return YES;
    }
    return YES;
}
-(void)showInView:(UIView *)view
{
    UIViewController *viewController = [self viewController];
    
    [UIView animateWithDuration:0.3 animations:^{
        viewController.view.frame = CGRectMake(self.frame.origin.x, -216 - 37, viewController.view.frame.size.width, viewController.view.frame.size.height);
    }];
}
-(void)hidenKeyboard
{
    [_textView resignFirstResponder];
//    UITableViewController *viewController = (UITableViewController *)[self viewController];
//    
//    
//    [UIView animateWithDuration:0.3 animations:^{
//        viewController.tableView.frame = CGRectMake(self.frame.origin.x, 0, viewController.view.frame.size.width, viewController.view.frame.size.height);
//    }];
//    [UIView animateWithDuration:0.3 animations:^{
//       viewController.view.frame = CGRectMake(self.frame.origin.x, 0, self.frame.size.width, self.frame.size.height);
//    } completion:^(BOOL finished) {
//        [self removeFromSuperview];
//    }];

}
- (UIViewController *)viewController {
    for (UIView* next = [self superview]; next; next = next.superview) {
        UIResponder *nextResponder = [next nextResponder];
        if ([nextResponder isKindOfClass:[UIViewController class]]) {
            return (UIViewController *)nextResponder;
        }
    }
    return nil;
}
#pragma  mark- 获得键盘高度
- (void)registerForKeyboardNotifications
{
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWasShown:) name:UIKeyboardDidShowNotification object:nil];
    
   }
- (void) keyboardWasShown:(NSNotification *) notif
{
    NSLog(@"%@", notif);
    NSDictionary *info = [notif userInfo];
    NSValue *value = [info objectForKey:UIKeyboardFrameBeginUserInfoKey];
    _keyboardSize = [value CGRectValue].size;
    
    NSLog(@"keyBoard:%f", _keyboardSize.height);  //216
    ///keyboardWasShown = YES;
}
//- (void) keyboardWasHidden:(NSNotification *) notif
//{
//    NSDictionary *info = [notif userInfo];
//    
//    NSValue *value = [info objectForKey:UIKeyboardFrameBeginUserInfoKey];
//    CGSize keyboardSize = [value CGRectValue].size;
//    NSLog(@"keyboardWasHidden keyBoard:%f", _keyboardSize.height);
//    // keyboardWasShown = NO;
//    
//}

- (void)setSelected:(BOOL)selected animated:(BOOL)animated {
    [super setSelected:selected animated:animated];

    // Configure the view for the selected state
}

@end
